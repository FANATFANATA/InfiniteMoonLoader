### SA
## MoonLoader
# Development​

НОВЫЙ ГАЙД: Информация - Гайд - Всё о Lua скриптинге для MoonLoader(https://blast.hk/threads/22707/)
Информация в этом неполная и устаревшая!


Спойлер: Не очень важная инфа

Списки функций и изменений
Все функции, включая опкоды - moonloader - functions | BlastHack — DEV_WIKI (https://www.blast.hk/wiki/moonloader:functions)
Функции, основанные на опкодах, но отличающиеся от оригинала - moonloader - changed_opcodes | BlastHack — DEV_WIKI (https://www.blast.hk/wiki/moonloader:changed_opcodes)
Удаленные и не добавленные опкоды, имеющие замену - moonloader - removed_opcodes | BlastHack — DEV_WIKI (https://www.blast.hk/wiki/moonloader:removed_opcodes)
Вырезанные опкоды ненужные в Lua и не имеющие назначения - moonloader - missing_opcodes | BlastHack — DEV_WIKI (https://www.blast.hk/wiki/moonloader:missing_opcodes)
Стандарт
Прежде чем начать говорить непосредственно о разработке, нужно сказать пару слов про стандарт.
Стандарт необходим в любой сфере разработки. Наличие стандарта и следование ему позволяет избежать конфликтов между разными продуктами, а также способствует качеству разработки. MoonLoader тоже старается придерживаться кое-каких стандартов.
Первое - это иерархия директорий.

'moonloader' - основная директория MoonLoader. В ней располагаются скрипты, лог-файл 'moonloader.log' и остальные поддиректории, имеющие отношение к Lua-скриптам.
'moonloader\lib' - эта директория предназначена для библиотек и модулей.
'moonloader\config' - для конфигов любого вида, в т.ч. и конфигов в виде скриптов.
'moonloader\resource' - здесь располагаются все ресурсы, используемые скриптами. В настоящий момент из подпапки 'txd' в этой директории загружаются .txd-файлы скриптовой функцией 'loadTextureDictionary'.
На текущий момент в набор MoonLoader уже входят некоторые библиотеки.

'moonloader' - инклуд, содержащий константы, относящиеся к MoonLoader
'sampfuncs' - константы плагина SAMPFUNCS
'bitex' - расширение стандартной библиотеки 'bit'
'vector3d' - класс 3D-вектора
'matrix3x3' - класс трёхмерной матрицы вращения
'game.models' - список идентификаторов основных моделей игры
'game.globals' - список идентификаторов глобальных переменных игры
Второе - встроенная информация о скрипте.
Задаётся внутри скрипта с помощью функций. Использовать вовсе не обязательно, но желательно.

script_name(string name) - задаёт название скрипта
script_author(string author) - псевдоним функции 'script_authors', отличается только более подходящим названием для указания одного автора
script_description(string description) - задаёт описание скрипта
script_version_number(int version) - задаёт числовую версию скрипта, предназначен преимущественно для системы проверки обновлений
script_version(string version) - задаёт текстовую версию скрипта
script_authors(string author, ...) - задаёт список авторов (разработчиков) скрипта
script_dependencies(string name, ...) - задаёт зависимости скрипта, предназначен для вывода. в будущем получит дополнительную функциональность
script_moonloader(int version) - задаёт минимальную требуемую версию MoonLoader, выводит сообщение об ошибке, если версия не соответствует (не прекращает работу скрипта)
Третье - глобальные переменные.

Hello, World!
Lua:
print("Hello, World!")
Так бы выглядел "Hello world" в обычном Lua.
В MoonLoader-е глобальная область скрипта не используется для выполнения основной части скрипта. Вместо этого весь основной код скрипта вызывается из функции 'main'. Так что "Hello world" в MoonLoader-е должен выглядеть так:
Lua:
function main()
  print("Hello, World!")
end
-- Будет выведено "Hello, World!" и скрипт завершит работу.
Но... Почему?
Глобальная область скрипта предназначена для определения информации о скриптах, загрузки библиотек и конфигов. Её код выполняется ещё до того, как игра начинает загружаться. Функция 'main', же, выполняется уже после того, как игра загружена и внутри этой функции могут быть использованы задержки с помощью 'wait':
Lua:
-- устанавливаем информацию о скрипте
script_name("Restore health")
script_author("noname_noob")
-- загружаем константы MoonLoader, в этом файле содержатся коды клавиш
require "lib.moonloader"

function main()
  while true do -- бесконечный цикл
    wait(0) -- в бесконечных циклах задержка необходима, хотя бы нулевая
    if isKeyDown(VK_1) and isPlayerPlaying(playerHandle) then -- если клавиша '1' нажата и игрок уже создан
      setCharHealth(playerPed, 100) -- устанавливаем себе 100 очков здоровья
      while isKeyDown(VK_1) do wait(100) end -- и ждём, пока клавиша не будет отпущена
    end
  end
end

Задержка 'wait' может быть использована только внутри тела подпрограммы 'main' (естественно и во вложенных вызовах тоже) и в скриптовых потоках, добавленных в версии .021. Говорю об этом заранее, потому что дальше будет о событиях и в них задержку таким методом использовать нельзя.

Грубо говоря, события - это функции, которые выполняются сами, когда происходит какое-то действие. Например, загружается новый скрипт или завершается игра.
Текущая версия MoonLoader уже включает в себя несколько событий.
Этот скрипт использует событие onScriptMessage для перехвата всех скриптовых сообщений и вывода их в чат:
Lua:
-- выполняется когда какой-то скрипт выводит сообщение функцией 'print'
function onScriptMessage(msg, script)
  -- желательно проверить, т.к. скрипты могут выводить сообщения и до того, как всё это будет доступно
  if isOpcodesAvailable() and isSampfuncsLoaded() and isSampAvailable() then
    sampAddChatMessage(script.name .. ": ".. msg, 0xFFFFFF) -- добавляем сообщение в чат SA:MP
  end
end

function main()
  wait(-1) -- бесконечная задержка
  -- если скрипт больше не выполняет никаких действий,
  -- но надо чтобы он продолжал работать и обрабатывать события, то
  -- в нём можно сделать бесконечную задержку таким способом, чтобы он не завершился сам
end
Список всех событий с описанием сейчас здесь.

Спойлер: Примеры скриптов

Примечание: для корректного отображения русских символов в игре переключите кодировку в своём редакторе на "ANSI" или "Windows-1251".

Компиляция
Как уже было сказано ранее, компиляция вообще не нужна. Но если по какой-то причине вы всё же хотите скомпилировать свой скрипт, сделать это можно с помощью компилятора LuaJIT. MoonLoader загружает и скомпилированные скрипты с расширением '.luac'.

В принципе, этой информации уже достаточно, чтобы начать разрабатывать Lua-скрипты под MoonLoader.
Вдобавок я хотел бы порекомендовать какой-нибудь хороший учебник по языку, но, к сожалению сам изучал его как попало и точно не знаю что лучше предложить. Если есть какие-то предложения - делитесь, закреплю их тут.
"Lua за 15 минут": Learn Lua in Y Minutes (https://learnxinyminutes.com/docs/ru-ru/lua-ru/)
Очень рекомендую установить скрипты "SF Integration", "ML AutoReload", "ML ReloadAll", "ScriptManager" - они сильно помогают в разработке (описание см. в основной теме).

Что будет дальше
MoonLoader продолжит развиваться. С выходом последних обновлений уже были добавлены встроенные библиотеки для работы с памятью, конфигами, потоками, добавлено большое количество встроенных функций, а сейчас в планах добавление обширного апи DirectX, более обширная поддержка одиночной игры и полное избавление от зависимости в SAMPFUNCS и CLEO. Любые ваши предложения тоже приветствуются.

Эта тема создана для обсуждения вопросов, касающихся разработки под MoonLoader, а так же для предложений по изменению/дополнению функциональности, касающейся разработки. Для всего остального - основная тема.
Вся дополнительная информация по MoonLoader располагается на Wiki.

Официальная тема с руководством по началу разработки на GTAForums (Official "getting started guide" in English on GTAForums)

Напоминаю, если вы заинтересованы, рекомендую подписаться на тему, чтобы ничего не пропустить.
